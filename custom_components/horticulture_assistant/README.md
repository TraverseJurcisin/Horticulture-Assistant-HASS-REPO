# Component Internals

This directory contains the Home Assistant integration that powers Horticulture
Assistant. The integration is organised into cohesive packages so profiles,
coordinators, analytics, and cloud features can evolve independently.

---

## Platform Matrix

| Platform | Module | Highlights |
|----------|--------|------------|
| Sensors | `sensor.py` | Core telemetry (environment metrics, lifecycle stats, cloud diagnostics, analytics snapshots). |
| Binary sensors | `binary_sensor.py` | Threshold monitors, status flags, entitlement availability, and profile health checks. |
| Numbers | `number.py` | Advisory targets and override inputs (DLI, irrigation cadence, nutrient intervals). |
| Switches | `switch.py` | Optimistic irrigation/fertigation toggles to integrate with external controllers. |

Device triggers and conditions live in `device_trigger.py` and
`device_condition.py`; blueprints under `blueprints/automation/` demonstrate how
to use them.

---

## Key Packages & Modules

### Profile & Storage Layer

- `profile_registry.py` – Authoritative in-memory registry that merges entries
  from local JSON, runtime overrides, and optional cloud snapshots.
- `profile_store.py` / `storage.py` – File-backed storage for user profiles,
  datasets, and cached cloud data. Handles migrations and atomic writes.
- `resolver.py` – Resolves species → cultivar → line inheritance and returns
  provenance-rich values.
- `profile/` – Domain models, statistics calculators, and JSON schema helpers.

### Coordinators & Entities

- `coordinator_local.py` – Polls Home Assistant sensors, computes derived
  metrics, and updates entities for each profile device.
- `coordinator_ai.py` – Surfaces AI-derived recommendations when entitlements
  are present.
- `coordinator.py` – Shared utilities for building coordinator payloads and
  scheduling refreshes.
- `entity.py` / `entity_base.py` – Base classes shared across sensor, binary,
  number, and switch entities.

### Analytics & Advisory Logic

- `analytics/` – Long-running analytics (yield, nutrient cadence, success
  scoring) exposed as sensors and diagnostics.
- `sensor_catalog.py` & `sensor_validation.py` – Device class metadata and
  validation helpers that power the options flow and logging services.
- `irrigation_bridge.py` – Applies irrigation plans generated by local logic or
  cloud AI, exposing clear service responses for automations.
- `fertilizer_formulator.py` – Nutrient formulation helpers used by advisory
  services.

### Cloud & AI Integrations

- `cloudsync/` – Auth client, sync manager, resolver microservice, and edge
  worker that queue/consume events when cloud sync is enabled.
- `entitlements.py` – Derives feature availability from account/tenant metadata.
- `ai_client.py` / `ai_utils.py` – Pluggable client for AI-backed
  recommendations and profile generation.
- `health_monitor.py` / `system_health.py` – Report integration/system health to
  Home Assistant diagnostics.

### Services & Automations

- `services.py` / `services.yaml` – Register profile CRUD, sensor linking,
  provenance inspection, lifecycle logging, cloud login/sync, irrigation,
  recompute/reset helpers, and AI/analytics endpoints.
- `automation/` – Utilities shared by automation blueprints and service
  handlers.
- `backups/` & `storage.py` – Helper routines for exporting/importing datasets
  and profile archives.

### Utility Modules

- `engine/` – Metric calculators (environment, light, irrigation, nutrient
  conversions) reused by coordinators and scripts.
- `validators.py` – JSON schema enforcement and repair issue helpers.
- `utils/` – Entry helpers, dataset loaders, and small reusable utilities.

---

## Runtime Flow

1. `__init__.py` loads configuration, initialises the `ProfileRegistry`, and
   starts coordinators for each config entry.
2. Coordinators gather sensor readings, merge analytics/history data, and push
   updates to entities.
3. Services registered in `services.py` manipulate the registry, link sensors,
   and append lifecycle events. Many services reuse the same validation paths as
   the options flow to guarantee consistent payloads.
4. Optional cloud sync spins up the edge worker to push local events and consume
   cloud deltas. Diagnostics entities are updated in the same cycle.

---

## Development Tips

- Keep new logic pure when possible (`helpers/`, `engine/`) to simplify unit
  testing.
- Update `translations/` when adding new config or option strings so the UI
  stays coherent.
- Tests live under `tests/` inside this package; run `pytest -q` to execute the
  Home Assistant harness.
- Use `scripts/sort_manifest.py` before release packaging to keep manifests and
  datasets in stable order.

For a high-level overview of the entire repository see the root
[`README.md`](../../README.md); dataset documentation lives alongside each data
subdirectory.
